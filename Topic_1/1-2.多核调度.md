# 1-2 多核调度

❓问题 : 内核对进程调度时发送了什么 ?

# 1. 进程调度的本质

## 1.1 **任务** / **进程** 切换

>- **$\color{red}{即 : 上下文切换 , 内核对处理器上执行的进程进行切换}$**
>-  "上下文" 指 : 寄存器的值
>- "上下文切换" 指 : 
>   - 将寄存器的值保存到内存中 (进程被剥夺处理器，停止执行)
>   - 将另一组寄存器的值从内存中加载到寄存器 (调度下一个进程执行)
>
>
><img src="./assets/image-20230828165910401.png" alt="image-20230828165910401" />
>
><img src="./assets/image-20230828170151878.png" alt="image-20230828170151878" />

## 1.2 进程调度的本质

>- 当时间片耗完 , 不管进程正在执行什么代码 , 都一定会发生上下文切换! 
>
><img src="./assets/image-20230828170252166.png" alt="image-20230828170252166" />
>
>- 上下文切换必然导致进程状态的状态
>- 上下文切换由中断触发 (时钟中断 , IO中断 , 等)
>
><img src="./assets/image-20230828172710581.png" alt="image-20230828172710581" />
>
>❓有趣的问题 : 上下文切换时 , 突然收到一个中断会发生什么?
>
>现代操作系统在进行上下文切换之前,一般都会把中断关掉 , 切换完成再把中断打开去响应

## 1.3 详解 Linux 进程状态 ( `ps au` )

><img src="./assets/image-20230828180934796.png" alt="image-20230828180934796" />

## 1.4 编程实验

[[参考链接:null]]()

### 1.4.1 主线程有 `sleep(...)`

><img src="./assets/image-20230829111458402.png" alt="image-20230829111458402" />
>
><img src="./assets/image-20230829111401777.png" alt="image-20230829111401777" />

### 1.4.2 主线程没有 `sleep(...)`

><img src="./assets/image-20230829112347286.png" alt="image-20230829112347286" />
>
><img src="./assets/image-20230829113149224.png" alt="image-20230829113149224" />

### 1.4.3 加入子线程

><img src="./assets/image-20230829114051085.png" alt="image-20230829114051085" />
>
><img src="./assets/image-20230829114748807.png" alt="image-20230829114748807" />
>
><img src="./assets/image-20230829134321945.png" alt="image-20230829134321945" />
>
><img src="./assets/image-20230829135456635.png" alt="image-20230829135456635" />
>
>```tex
>通过 watch ps au 命令看到CPU达到199% , 再通过lscpu命令看到当前电脑是一个多核CPU
>可以推出:
>当前进程占用了两个CPU核心,每一个CPU核心都在执行当前进程中的每一个线程
>
>以上实验得出一个结论:
>对于linux来说,调度的基本单位是线程
>```

### 1.4.4 指定CPU执行

><img src="./assets/image-20230829140917747.png" alt="image-20230829140917747" />
>
>```
>通过以上实验得出:
>linux会把线程调度到不同的CPU核心上执行
>```

# 2. 细说空闲状态

>- 处理器上电后 , **$\color{red}{开始一直不停的向下执行指令}$**
>- 当系统中没有进程时 , 会执行一个 **$\color{SkyBlue}{"不执行任何操作"}$** 的空闲进程
>- 空闲进程的职责 : 执行特殊指令使处理器进入休眠状态 (低功耗状态)
>- **$\color{red}{空闲状态是一种暂态}$** , 但凡出现就绪态进程 , 空闲状态立即结束

